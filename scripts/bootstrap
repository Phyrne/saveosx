#! /bin/bash

# Ensure script is not being run with root privileges
if [[ $EUID -eq 0 ]]; then
   echo "Please don't run this script with root priveleges!"
   exit 1
fi

if [ $(uname -s) != "Darwin" ]; then
    echo "This script is for use with OS X!"
    exit 1
fi

# Fancy title function
title() {
  COLUMNS=$(tput cols)
  tput clear
  Y=$((($COLUMNS-${#MESSAGE})/2))
  X=1
  tput cup $X $Y
  echo -e "${MESSAGE}"
}

# Safe run function to ensure commands are executed successfully
saferun() {
  typeset cmnd="$*"
  typeset ret_code

  eval  $cmnd
  ret_code=$?
  
  if [ $ret_code != 0 ]; then
     echo -e ""$RED_UL"\n\nIt looks like there was an issue "$ERR_MSG"!"$ESC"\n\nExiting..."
     exit $?
  fi
}

# ANSI properties/colours
ESC='\033[0m'
BOLD='\033[1m'
BLUE='\033[38;34m'
BLUE_UL='\033[38;4;34m'
GREEN='\033[38;32m'
GREEN_UL='\033[38;4;32m'
CYAN='\033[38;36m'
CYAN_UL='\033[38;4;36m'
RED='\033[38;31m'
RED_UL='\033[38;4;31m'
PURPLE='\033[38;35m'
PURPLE_UL='\033[38;4;35m'
YELLOW='\033[38;33m'
YELLOW_UL='\033[38;4;33m'

# First, drop any chached sudo access (sudo does not require a password to perform this function)
sudo -k

# Welcome screen
MESSAGE=""$BLUE_UL"Welcome to Save OS X!"$ESC""

title
cat << EOM

Welcome to the Save OS X project, an effort to make OS X
a more comfortable system for hackers, developers & power users.

This script will set up your environment for you. It will automatically
install pkgsrc & its associated binary package manager - pkgin.
You will also have the choice to install Git & implement a seamless
X11 environment.

Please enter your password for sudo authentication

EOM

ERR_MSG="authenticating sudo access.\nPlease ensure you typed your password correctly" # Set error message to be echo'd should sudo authentication fail
saferun sudo echo "sudo authenticaion successful!" # Prompt for initial sudo password (will be updated througout with `sudo -v`)
echo 
read -r -p "Press [Enter] to continue..."
clear

# Grab pkgsrc
MESSAGE=""$RED_UL"pkgsrc/pkgin"$ESC""
title
cat << EOM

`echo -e ""$YELLOW_UL"pkgsrc"$ESC""`
pkgsrc is a framework for building third-party software on NetBSD and other UNIX-like systems,
currently containing over 12000 packages. It is used to enable freely available software to be
configured and built easily on supported platforms.

`echo -e ""$YELLOW_UL"pkgin"$ESC""`
The pkgin command is aimed at being an apt/yum like tool for managing pkgsrc binary packages.
It relies on pkg_summary(5) for installation, removal and upgrade ofpackages and associated 
dependencies, using a remote repository.

Proceeding to download and install essential tools....

EOM
sudo -v # Keep sudo authentication open

# Download and install pkgsrc
echo "Fetching pkgsrc from the Save OS X repo..."
ERR_MSG="retrieving the boostrap tarball from the Save OS X repo" # Set the error message to be echo'd should the curl fail

# Check architecture
if [[ $(uname -m) == 'x86_64' ]] ; then
  saferun curl -s -o /tmp/bootstrap.tar.gz http://pkgsrc.saveosx.org/Darwin/bootstrap/bootstrap-x86_64.tar.gz # Safely attempt to retrive the x86_64 pkgsrc bootstrapper from the Save OS X repo, if it fails, exit
else
  echo ""$RED_UL"We only support x86_64 systems!"$ESC""
fi

sudo -v # Keep sudo authentication open

# Check for Home Brew install
if [[ $(which brew | awk -F/ '{print$NF}' | grep -v 'not found') == 'brew' ]]; then
    BREW_INSTALLED="true"
  else
    BREW_INSTALLED="false"
fi

# If the 'brew' binary is found, echo instructions on removal and exit
if [ ${BREW_INSTALLED} == "true" ]; then
  echo 
  echo -e ""$RED"It looks like you have Home Brew installed. This could seriously conflict with pkgsrc!"
  echo -e "As we don't wish to affect what you may have implemented, we'll leave it up to you to" 
  echo -e "remove it."$ESC""
  echo 
  echo -e ""$BLUE_UL"Once your system is rid of Home Brew; simply re-run this script to get going again!"$ESC""
cat << EOM

For now, here are the steps you need to take (with root privileges) to eradicate Home Brew from your system:

cd \`brew --prefix\`
rm -rf Cellar
brew prune
rm \`git ls-files\`
rm -rf Library/{Homebrew,Aliases,Formula,Contributions}
rm -rf .git
rm -rf ~/Library/Caches/Homebrew

EOM
  echo -e ""$RED_UL"WARNING"$ESC""$RED":  This will remove all software installed with Home Brew!"$ESC""
  exit 1
fi

# Check for MacPorts install
if [[ $(which port | awk -F/ '{print$NF}' | grep -v 'not found') == 'port' ]]; then
    PORTS_INSTALLED="true"
  else
    PORTS_INSTALLED="false"
fi

# If the 'port' binary is found, echo instructions on removal and exit

if [ ${PORTS_INSTALLED} == "true" ]; then
cat << EOM

`echo -e ""$RED"It looks like you have MacPorts installed. This could seriously conflict with pkgsrc!"`
`echo -e "As we don't wish to affect what you may have implemented, we'll leave it up to you to"`
`echo -e "remove it."$ESC""`

`echo -e ""$BLUE_UL"Once your system is rid of MacPorts; simply re-run this script to get going again!"$ESC""`

 For now, here are the steps you need to take (with root privileges) to eradicate MacPorts from your system:

port -fp uninstall installed
rm -rf /opt/local
rm -rf /Applications/{DarwinPorts,MacPorts}
rm -rf /Library/{LaunchDaemons/org.macports.*,Receipts/DarwinPorts*.pkg,\\
Receipts/MacPorts*.pkg,Receipts/MacPorts*.pkg,Tcl/darwinports1.0,Tcl/macports1.0}
rm -rf ~/.macports

`echo -e ""$RED_UL"WARNING"$ESC""$RED":  This will remove all software installed with MacPorts!"$ESC""`
EOM
exit 1
fi

echo -e "pkgsrc retrieved successfully, proceeding to install...\n"
cd /; sudo tar xf /tmp/bootstrap.tar.gz 2>&1 > /dev/null # extract the pkgsrc bootstrap in the root directory
echo -e "\n"$GREEN"pkgsrc installed."$ESC" Adding Save OS X repo..."
sudo chmod a+w /usr/pkg/etc/pkgin/repositories.conf   # Temporarily drop permissions

# Add Save OS X repo
if [[ $(uname -m) == 'x86_64' && $(grep 'saveosx' /usr/pkg/etc/pkgin/repositories.conf | wc -l) == 0 ]]; then
    echo "http://pkgsrc.saveosx.org/Darwin/2013Q3/x86_64/All" >> /usr/pkg/etc/pkgin/repositories.conf           # No sudo access to file
    echo "Your system has now been set up to use the Save OS X repo!"
elif [[ $(uname -m) == 'x86_64' && $(grep 'saveosx' /usr/pkg/etc/pkgin/repositories.conf | wc -l) -gt 0 ]]; then
    echo "Your system has now been set up to use the Save OS X repo!"
else
  echo ""$RED_UL"We only support x86_64 systems!"$ESC""
  exit 1
fi
sudo chmod og-w /usr/pkg/etc/pkgin/repositories.conf # Change permissions back
echo 
sudo -v # Keep sudo authentication open
echo "Updating pkgsrc repository information..."
sudo /usr/pkg/bin/pkgin -y update # Update the pkgsrc repository information
sudo -v # Keep sudo authentication open
echo 

# Grab XQuartz
MESSAGE=""$BLUE_UL"XQuartz"$ESC"
title
cat << EOM

XQuartz is an open-source effort to develop a version of the X.Org X Window System that runs on OS X.
Together with supporting libraries and applications, it forms the X11.app that Apple has shipped with
OS X since version 10.5.

EOM

# Ask user if they would like to install XQuartz
while :
do
  read -r -p "Would you like to install XQuartz? [y/n] " ANSWER
    case $ANSWER in
      [yY][eE][sS]|[yY])
          export X_INST="true" 
          break
          ;;
      [nN][oO]|[nN])
          export X_INST="false"
          read -r -p "Press [Enter] to continute..."
          break
          ;;
      *)
          echo "Please answer yes or no..."
    esac
done

# Fetch & install XQuartz if it isn't already installed
if [[ ${X_INST} == "true" && $(system_profiler SPApplicationsDataType | grep XQuartz 2> /dev/null | wc -l) -lt 1 ]] && [[ $(pkgin list | grep -i 'xquartz' | wc -l) -lt 1  ]]; then
  echo 
  ERR_MSG="installing XQuartz"
  echo "Installing XQuartz..."
  saferun pkgin -y in xquartz
sudo -v # Keep sudo authentication open
  echo -e "\n"$GREEN"XQuartz installed successfully!"$ESC""
  export PATH=/usr/pkg/bin:/usr/pkg/sbin:/opt/X11/bin:$PATH # Update path so new binaries can be found (including X11 apps)
  umount /Volumes/xquartz
else
  echo 
  echo -e "\n"$GREEN"It looks like XQuartz is already installed..."$ESC""
  export PATH=/usr/pkg/bin:/usr/pkg/sbin:$PATH # Update path to so new binaries can be found (not including X11 apps)
fi
read -r -p "Press [Enter] to continute..."
sudo -v # Keep sudo authentication open

# Git screen
MESSAGE=""$GREEN_UL"Git"$ESC""

title
cat << EOM

Using Save OS X requires Git. Apple's implementation of Git is
included with XCode. Unless you're a developer of software for
OS X/iOS, this isn't necessary

Even if you do have XCode intalled, installing Git from pkgsrc
will get you a more recent revision.

EOM

sudo -v # Keep sudo authentication open

# Ask user if they would like to install Git from pkgsrc
while :
do
  read -r -p "Would you like to install Git from pkgsrc? [y/n] " ANSWER
    case $ANSWER in
      [yY][eE][sS]|[yY])
          ERR_MSG="installing Git with pkgin"
          echo 
          echo -e "Installing Git with pkgin...\n\n"
          sudo /usr/pkg/bin/pkgin -y in git-base git-docs
          ls /usr/pkg/bin | grep 'git' | while read GIT_BIN ;
	    do sudo ln -sf /usr/pkg/bin/${GIT_BIN} /usr/bin/${GIT_BIN} ;
	  done
          break
          ;;
      [nN][oO]|[nN])
          read -r -p "Press [Enter] to continute..."
          break
          ;;
      *)
          echo "Please answer yes or no..."
    esac
done

sudo -v # Keep sudo authentication open

# Check to see if user installed from pkgsrc
if [ $(/usr/pkg/bin/pkgin list | grep '^git' | wc -l) -gt 0 ]; then
  echo 
  echo -e ""$GREEN"Succsessfully installed Git from pkgsrc!"$ESC""
  read -r -p "Press [Enter] to continute..."
fi

# PATH screen
MESSAGE=""$GREEN_UL"Update System PATH"$ESC""

title
# Prepend binary dirs to system-wide path
echo 
echo -e "Updating \$PATH variable so new binaries can be found...\n"
echo -e "/usr/pkg/bin\n/usr/pkg/sbin\n/opt/X11/bin\n$(cat /etc/paths)" > /tmp/paths
sudo mv /tmp/paths /etc/paths && sudo chown root:wheel /etc/paths

sudo -v # Keep sudo authentication open

# Check user's shell
SHELLRC=~/.$(echo $SHELL | cut -d'/' -f3)rc
echo "It looks like your shell's rc file is $SHELLRC"
while :
do
  read -r -p "Add system PATH evaluation to $SHELLRC or another file? [yes/other] " ANSWER
    case $ANSWER in
      [yY][eE][sS]|[yY])
        break
        ;;
      [oO][tT][hH][eE][rR])
        export SHELLRC="user_defined" 
        break
        ;;
      *)
        echo "Please answer 'yes' or 'other'..."
        echo 
    esac
done

# Ask for user's shell if necessary
if [ ${SHELLRC} == "user_defined" ]; then
  read -r -p "Please enter the full path to your shell's rc file: " SHELLRC
  export SHELLRC
fi

if [ ! -f ${SHELLRC} ]; then
  echo -e "It doesn't look like $SHELLRC exists...\nA new shell rc will be created\n"
fi

# Update user's shell rc file with new $PATH 
echo -e "\n# Evaluate system PATH\nif [ -x /usr/libexec/path_helper ]; then\n    eval \`/usr/libexec/path_helper -s\`\nfi" >> ${SHELLRC}

# Evaluate system path to circumvent explicit calls of new binaries
if [ -x /usr/libexec/path_helper ]; then
  eval `/usr/libexec/path_helper -s`
fi

echo 
echo -e ""$GREEN"Your system's \$PATH has been updated"$ESC"\n\n"
read -r -p "Press [Enter] to continue..."

sudo -v # Keep sudo authentication open

# Clone Save OS X git repo and run through the other scripts
git clone git://github.com/Phyrne/saveosx /tmp/saveosx
cd /tmp/saveosx
sudo -v # Keep sudo authentication open
sudo ./scripts/x-setup

# Final screen!
clear
MESSAGE=""$GREEN_UL"Hurrah! You Saved OS X!"$ESC""
title
cat << EOM

All processes are complete! So what now? Well, we reccomend you read the
manpage for pkgin at least, as you'll be managing all your non-Apple software
with this excellent package manager.

From here, get your X11 environment set up, and more importantly; enjoy!

EOM
echo -e ""$BLUE"Please visit "$BLUE_UL"http://saveosx.org/"$ESC""$BLUE" for all the latest news and other ramblings from the authors:"$ESC""
echo -e ""$YELLOW"Youri Mouton & Calum MacRae"$ESC""
echo 
echo "You can reach us at: youri.mout@gmail.com & calum0macrae@gmail.com"
echo -e "\n\n"
echo -e ""$GREEN"Thanks for using Save OS X!"$ESC""
exit 0
